let mdtgver = 0.16;

let tdCss = {};
let tdCssText = "";
let tdCssTextMin = "";
$(function () {
  $('#mdtg-ver').text(mdtgver)

  $('input[name="td-theme"]:radio').change(function () {
    let val = $(this).val();
    if (val == 1) {
      $('.td-preview').contents().find('html').addClass('dark');
    } else {
      $('.td-preview').contents().find('html').removeClass('dark');
    }
  });

  $('input.td-css').change(function () {
    let tdSel = $(this).data('sel');
    let tdProp = $(this).data('prop');
    let val = $(this).val();
    $(`input[data-sel="${tdSel}"][data-prop="${tdProp}"]`).val(val);
    if (tdSel in tdCss === false) tdCss[tdSel] = [];
    tdCss[tdSel].forEach((e) => {
      if (e.startsWith(`${tdProp}:`)) {
        let index = tdCss[tdSel].indexOf(e)
        tdCss[tdSel].splice(index, 1)
      }
    })
    if (val) tdCss[tdSel].push(`${tdProp}:${val};`);
    tdCss[tdSel].sort()
    tdCssText = "";
    Object.keys(tdCss).forEach((key) => {
      if (tdCss[key].length === 0) delete tdCss[key];
      else {
        tdCssText = tdCssText + `${key}{`
        tdCss[key].forEach((e) => {
          tdCssText = tdCssText + e;
        })
        tdCssText = tdCssText + "}\n"
      }
    })
    $('.td-preview').contents().find('style').text(tdCssText);
    $('.td-css-obj').val(JSON.stringify(tdCss));
    tdCssText = tdCssText + `/*Generated by https://mdtg.sbmr.in v${mdtgver}*/`
    $('.td-css-text').val(tdCssText);
    tdCssTextMin = tdCssText.replace(/\r?\n/g, "");
    $('.td-css-text-min').val(tdCssTextMin);
  });

  $('.td-css-import').change(function () {
    tdCss = JSON.parse($(this).val());
    Object.keys(tdCss).forEach((key) => {
      tdCssText = tdCssText + `${key}{`
      tdCss[key].forEach((e) => {
        let propVal = e.split(':');
        let prop = propVal[0];
        let val = propVal[1].replace(/;/g, "");
        console.log(key,prop,val)
        $(`input[data-sel="${key}"][data-prop="${prop}"]`).val(val);
        tdCssText = tdCssText + e;
      })
      tdCssText = tdCssText + "}\n"
    })
    $('.td-preview').contents().find('style').text(tdCssText);
    $('.td-css-obj').val(JSON.stringify(tdCss));
    tdCssText = tdCssText + `/*Generated by https://mdtg.sbmr.in v${mdtgver}*/`
    $('.td-css-text').val(tdCssText);
    tdCssTextMin = tdCssText.replace(/\r?\n/g, "");
    $('.td-css-text-min').val(tdCssTextMin);
  })
});